{% extends "layout.html" %}
{% load static %}
{% block meta_title %}Connect{% endblock meta_title %}
{% block meta_description %}Connect to {{ WEBSITE_TITLE }} from your browser.{% endblock meta_description %}
{% block meta_url %}{% url 'connect' %}#connect{% endblock meta_url %}
{% block title %}Connect{% endblock title %}
{% block includes %}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
        <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
        <style>
            #terminal-container {
                height: 60vh;
                min-height: 200px;
                background-color: #000;
                border-radius: 0.25rem;
            }
            #terminal-container .xterm {
                height: 100%;
                padding: 0.25rem;
            }
            #command-form {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }
            #command-input {
                flex: 1;
                font-family: monospace;
                /* >= 16px prevents iOS auto-zoom on focus */
                font-size: 16px;
                padding: 0.375rem 0.5rem;
            }
            #connection-status {
                font-size: 0.875rem;
                font-weight: bold;
            }
            .status-connected { color: #4cbb17; }
            .status-disconnected { color: #d02b2b; }
            .status-connecting { color: #fa7; }

            /* --- Mobile / small-screen --- */
            @media (max-width: 767px) {
                #terminal-container {
                    /* Use dynamic viewport height to account for browser chrome. */
                    height: 55dvh;
                    min-height: 150px;
                }
                #send-btn { display: none; }
            }
        </style>
{% endblock includes %}
{% block scripts %}let focusTo = 'command-input'{% endblock scripts %}
{% block breadcrumbs %}
    <li class="breadcrumb-item active h2" aria-current="page" title="Connect">
        <a class="icon-link icon-link-hover" href="{% url 'connect' %}#connect">
            <svg class="bi" aria-hidden="true">
                <use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#globe"></use>
            </svg>
            <span id="connect">
                Connect
            </span>
        </a>
    </li>
{% endblock breadcrumbs %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <span id="connection-status" class="status-connecting">Connecting...</span>
    <button type="button" class="btn btn-sm btn-ishar" id="reconnect-btn" style="display:none;" title="Reconnect to {{ WEBSITE_TITLE }}">
        <svg class="bi" aria-hidden="true">
            <use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#arrow-clockwise"></use>
        </svg>
        Reconnect
    </button>
</div>
<div id="terminal-container"></div>
<form id="command-form" class="mt-2" autocomplete="off">
    <label for="command-input" class="visually-hidden">Command</label>
    <input type="text" id="command-input" class="form-control"
           placeholder="Enter command..."
           aria-label="MUD command input"
           autocapitalize="off"
           autocomplete="off"
           autocorrect="off"
           spellcheck="false"
           enterkeyhint="send"
           autofocus>
    <button type="submit" class="btn btn-ishar" id="send-btn" title="Send command">
        <svg class="bi" aria-hidden="true">
            <use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#send"></use>
        </svg>
    </button>
</form>
<script>
(function() {
    "use strict";

    // --- Elements ---
    var terminalContainer = document.getElementById("terminal-container");
    var commandForm = document.getElementById("command-form");
    var commandInput = document.getElementById("command-input");
    var statusEl = document.getElementById("connection-status");
    var reconnectBtn = document.getElementById("reconnect-btn");

    // --- Mobile detection (touch-capable small screen) ---
    var isMobile = ("ontouchstart" in window) && window.innerWidth < 768;

    // --- ANSI color theme (all 16 standard colors) ---
    var mudTheme = {
        background: "#000000",
        foreground: "#d6d6d7",
        cursor: "#d6d6d7",
        selectionBackground: "rgba(255, 170, 119, 0.4)",
        selectionForeground: "#ffffff",
        // Normal colors (SGR 30-37).
        black:   "#000000",
        red:     "#cc0000",
        green:   "#4cbb17",
        yellow:  "#cdcd00",
        blue:    "#4a86cf",
        magenta: "#cd00cd",
        cyan:    "#00cdcd",
        white:   "#c0c0c0",
        // Bright / bold colors (SGR 90-97).
        brightBlack:   "#666666",
        brightRed:     "#ff5555",
        brightGreen:   "#55ff55",
        brightYellow:  "#ffff55",
        brightBlue:    "#5599ff",
        brightMagenta: "#ff55ff",
        brightCyan:    "#55ffff",
        brightWhite:   "#ffffff",
    };

    // --- Terminal setup ---
    var term = new Terminal({
        cursorBlink: false,
        cursorInactiveStyle: "none",
        disableStdin: true,
        scrollback: 5000,
        fontSize: isMobile ? 13 : 14,
        fontFamily: "'Courier New', Courier, 'Liberation Mono', monospace",
        theme: mudTheme,
        convertEol: true,
    });

    var fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);

    var webLinksAddon = new WebLinksAddon.WebLinksAddon();
    term.loadAddon(webLinksAddon);

    term.open(terminalContainer);
    fitAddon.fit();

    // --- Command history ---
    var history = [];
    var historyIndex = -1;
    var savedInput = "";
    var MAX_HISTORY = 200;

    // --- Local echo & server echo state ---
    // When the MUD negotiates WILL ECHO it handles echoing (suppress local
    // echo during password prompts).  Otherwise we always echo locally.
    var serverEcho = false;

    // --- WebSocket ---
    var ws = null;

    function setStatus(text, cls) {
        statusEl.textContent = text;
        statusEl.className = cls;
    }

    function connect() {
        if (ws && ws.readyState <= WebSocket.OPEN) {
            ws.close();
        }

        var protocol = location.protocol === "https:" ? "wss:" : "ws:";
        var url = protocol + "//" + location.host + "/ws/connect";

        setStatus("Connecting...", "status-connecting");
        reconnectBtn.style.display = "none";

        ws = new WebSocket(url);

        ws.binaryType = "arraybuffer";

        ws.onopen = function() {
            setStatus("Connected", "status-connected");
            sendNaws();
            commandInput.focus();
        };

        ws.onmessage = function(event) {
            if (typeof event.data === "string") {
                // Check for echo-state control prefix from the consumer.
                if (event.data === "\x00ECHO_ON") {
                    serverEcho = true;
                    commandInput.type = "password";
                    return;
                }
                if (event.data === "\x00ECHO_OFF") {
                    serverEcho = false;
                    commandInput.type = "text";
                    return;
                }
                term.write(event.data);
            }
        };

        ws.onclose = function() {
            setStatus("Disconnected", "status-disconnected");
            reconnectBtn.style.display = "";
            term.writeln("\r\n\x1b[1;31m--- Disconnected ---\x1b[0m");
        };

        ws.onerror = function() {
            setStatus("Disconnected", "status-disconnected");
            reconnectBtn.style.display = "";
        };
    }

    function sendCommand(cmd) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(cmd + "\r\n");
        }
    }

    function sendNaws() {
        // Send a telnet NAWS (window size) update to the MUD server.
        // IAC SB NAWS <width-hi> <width-lo> <height-hi> <height-lo> IAC SE
        if (ws && ws.readyState === WebSocket.OPEN) {
            var cols = term.cols || 80;
            var rows = term.rows || 24;
            var nawsBytes = new Uint8Array([
                255, 250, 31,
                (cols >> 8) & 0xff, cols & 0xff,
                (rows >> 8) & 0xff, rows & 0xff,
                255, 240
            ]);
            ws.send(nawsBytes.buffer);
        }
    }

    // --- Debounced resize handler ---
    var resizeTimer = null;
    function onResize() {
        if (resizeTimer) clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            fitAddon.fit();
            sendNaws();
        }, 150);
    }

    // --- Event handlers ---
    commandForm.addEventListener("submit", function(e) {
        e.preventDefault();
        var cmd = commandInput.value;

        // Echo the command locally (dim/muted so it is distinct from
        // server output).  Skip echo when the server is handling it
        // (e.g. password prompts where WILL ECHO suppresses display).
        if (!serverEcho && cmd) {
            // SGR 90 = bright-black (dark gray), SGR 0 = reset.
            term.writeln("\x1b[90m" + cmd + "\x1b[0m");
        }

        sendCommand(cmd);

        // Add to history (avoid consecutive duplicates).
        if (cmd && (history.length === 0 || history[history.length - 1] !== cmd)) {
            history.push(cmd);
            if (history.length > MAX_HISTORY) {
                history.shift();
            }
        }
        historyIndex = -1;
        savedInput = "";

        // Keep the last command highlighted so it can be re-sent by
        // pressing Enter again, or replaced by typing a new command.
        commandInput.value = cmd;
        commandInput.select();
    });

    commandInput.addEventListener("keydown", function(e) {
        if (e.key === "ArrowUp") {
            e.preventDefault();
            if (history.length === 0) return;
            if (historyIndex === -1) {
                savedInput = commandInput.value;
                historyIndex = history.length - 1;
            } else if (historyIndex > 0) {
                historyIndex--;
            }
            commandInput.value = history[historyIndex];
            commandInput.select();
        } else if (e.key === "ArrowDown") {
            e.preventDefault();
            if (historyIndex === -1) return;
            if (historyIndex < history.length - 1) {
                historyIndex++;
                commandInput.value = history[historyIndex];
                commandInput.select();
            } else {
                historyIndex = -1;
                commandInput.value = savedInput;
            }
        }
    });

    reconnectBtn.addEventListener("click", function() {
        term.clear();
        connect();
    });

    // Resize: window and visual viewport (mobile keyboard show/hide).
    window.addEventListener("resize", onResize);
    if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", onResize);
    }

    // Click on terminal focuses the input.
    terminalContainer.addEventListener("click", function() {
        var selection = term.getSelection();
        if (!selection) {
            commandInput.focus();
        }
    });

    // --- Start ---
    connect();
})();
</script>
{% endblock content %}
{# Hide the player search form on the connect page to save vertical space. #}
{% block player_search_form %}{% endblock player_search_form %}
